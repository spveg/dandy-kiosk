<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="DandyRecords">
<title>DandyRecords — Paris Loves Vinyl</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Space+Mono&family=Epilogue:wght@200;300;400&display=swap" rel="stylesheet">
<style>
:root{
  /* ── DandyRecords Light Theme ── */
  --bg:#F7F5FF;          /* fond lavande très léger */
  --surface:#FFFFFF;     /* surfaces (header, sidebar, player) */
  --s2:#F0EEFF;          /* hover / surfaces secondaires */
  --border:#E2DCFF;      /* bordures légères */
  --border2:#C8BCFF;     /* bordures plus marquées */

  --violet:#7C3AED;      /* accent principal — interactif */
  --vlav:#B39DFF;        /* lavender — décoratif, badges */
  --vdim:#A78BFA;        /* violet intermédiaire */
  --vlight:#EDE9FF;      /* violet très pâle — backgrounds actifs */

  --text:#1A1A1A;        /* texte principal */
  --t2:#4A4458;          /* texte secondaire */
  --tdim:#8A7FAA;        /* texte tertiaire / placeholders */

  --red:#DC2626;         /* erreurs */
  --green:#16A34A;       /* succès / neuf */
  --shadow:rgba(124,58,237,.12);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}

/* ══════════════════════════════════════════
   LAYOUT — two modes controlled by body class
   body.mode-list  → sidebar + detail (current)
   body.mode-grid  → full-width grid
   ══════════════════════════════════════════ */

body{
  background:var(--bg);color:var(--text);
  font-family:'Epilogue',sans-serif;font-weight:400;
  display:grid;
  grid-template-rows:60px 1fr 76px;
  grid-template-columns:320px 1fr;
  grid-template-areas:"hd hd" "sb mn" "pl pl";
  transition:grid-template-columns .3s ease;
}
body.mode-grid{grid-template-columns:0px 1fr;}

/* HEADER */
header{grid-area:hd;display:flex;align-items:center;justify-content:space-between;padding:0 22px;border-bottom:1px solid var(--border);background:var(--surface);gap:10px;z-index:10;box-shadow:0 1px 0 var(--border);}
.logo{display:flex;align-items:baseline;gap:8px;flex-shrink:0}
.logo-name{font-family:'Epilogue',sans-serif;font-size:1.25rem;font-weight:700;color:var(--violet);letter-spacing:.04em;text-transform:uppercase}
.logo-sub{font-size:.65rem;letter-spacing:.18em;color:var(--tdim);text-transform:uppercase;font-weight:400}
.badge-event{font-size:.62rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--violet);border:1.5px solid var(--vlav);background:var(--vlight);padding:4px 10px;border-radius:20px;flex-shrink:0}
.nav-crumb{flex:1;display:flex;align-items:center;gap:7px;font-size:.72rem;letter-spacing:.04em;color:var(--tdim);overflow:hidden;min-width:0}
.crumb-sep{opacity:.4;flex-shrink:0}
.crumb-item{color:var(--violet);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;border-bottom:1px solid transparent;transition:border-color .15s;font-weight:600}
.crumb-item:hover{border-bottom-color:var(--violet)}
.crumb-root{cursor:pointer;opacity:.5;transition:opacity .15s;flex-shrink:0}
.crumb-root:hover{opacity:1}
.hd-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
.btn-refresh{background:none;border:1.5px solid var(--border2);border-radius:6px;color:var(--tdim);font-size:.65rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;padding:5px 10px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px}
.btn-refresh:hover{border-color:var(--violet);color:var(--violet)}
.btn-refresh.spinning .ri{animation:spin .7s linear infinite}
.ri{display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.view-toggle{display:flex;gap:3px;flex-shrink:0}
.vbtn{width:30px;height:28px;background:none;border:1.5px solid var(--border2);border-radius:6px;cursor:pointer;color:var(--tdim);display:flex;align-items:center;justify-content:center;transition:all .15s}
.vbtn:hover{border-color:var(--vdim);color:var(--vdim)}
.vbtn.on{border-color:var(--violet);color:var(--violet);background:var(--vlight)}
.vbtn svg{width:12px;height:12px;fill:currentColor}
.grid-search-wrap{flex:1;position:relative;display:none;max-width:380px}
body.mode-grid .grid-search-wrap{display:block}
body.mode-grid .nav-crumb{display:none!important}
.grid-search-wrap input{width:100%;background:var(--bg);border:1.5px solid var(--border2);border-radius:8px;padding:8px 32px 8px 32px;color:var(--text);font-family:'Epilogue',sans-serif;font-size:.92rem;outline:none;transition:border-color .2s}
.grid-search-wrap input:focus{border-color:var(--violet);box-shadow:0 0 0 3px var(--shadow)}
.grid-search-wrap input::placeholder{color:var(--tdim)}
.gsi{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--tdim);font-size:.95rem;pointer-events:none}

/* SIDEBAR */
aside{grid-area:sb;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;background:var(--surface);transition:opacity .2s}
body.mode-grid aside{opacity:0;pointer-events:none}
.search-wrap{position:relative;padding:10px 12px;border-bottom:1px solid var(--border)}
.search-wrap input{width:100%;background:var(--bg);border:1.5px solid var(--border2);border-radius:8px;padding:9px 32px 9px 32px;color:var(--text);font-family:'Epilogue',sans-serif;font-size:.92rem;outline:none;transition:border-color .2s}
.search-wrap input:focus{border-color:var(--violet);box-shadow:0 0 0 3px var(--shadow)}
.search-wrap input::placeholder{color:var(--tdim)}
.search-clear{position:absolute;right:20px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--tdim);cursor:pointer;font-size:.8rem;padding:2px 4px;transition:color .15s;line-height:1}
.search-clear:hover{color:var(--violet)}
.grid-search-wrap input{width:100%;background:var(--bg);border:1.5px solid var(--border2);border-radius:8px;padding:8px 32px 8px 32px;color:var(--text);font-family:'Epilogue',sans-serif;font-size:.92rem;outline:none;transition:border-color .2s}
.si{position:absolute;left:22px;top:50%;transform:translateY(-50%);color:var(--tdim);font-size:.92rem;pointer-events:none}
.afbar{padding:7px 12px;border-bottom:1px solid var(--border);display:none;align-items:center;justify-content:space-between;font-size:.68rem;font-weight:600;letter-spacing:.05em;background:var(--vlight)}
.afbar.show{display:flex}
.af-label{color:var(--violet);text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.af-clear{background:none;border:none;color:var(--tdim);cursor:pointer;font-size:.75rem;flex-shrink:0;padding:0 0 0 7px;transition:color .15s}
.af-clear:hover{color:var(--violet)}
.ftabs{display:flex;border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.ftabs::-webkit-scrollbar{display:none}
.ftab{flex-shrink:0;padding:8px 11px;font-size:.65rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--tdim);background:none;border:none;border-bottom:2.5px solid transparent;cursor:pointer;transition:all .15s;white-space:nowrap}
.ftab:hover{color:var(--t2)}
.ftab.on{color:var(--violet);border-bottom-color:var(--violet)}
.sb-toolbar{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;border-bottom:1px solid var(--border);background:var(--bg)}
.count{font-size:.65rem;font-weight:500;letter-spacing:.06em;color:var(--tdim);text-transform:uppercase}
.list{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}
.list::-webkit-scrollbar{width:3px}
.list::-webkit-scrollbar-thumb{background:var(--border2)}

/* LOADING */
.loading-screen{position:fixed;inset:0;background:var(--surface);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px}
.loading-screen.hidden{display:none}
.loading-logo{font-size:1.8rem;font-weight:700;color:var(--violet);text-transform:uppercase;letter-spacing:.06em}
.loading-msg{font-size:.7rem;font-weight:500;letter-spacing:.16em;color:var(--tdim);text-transform:uppercase}
.loading-bar{width:200px;height:3px;background:var(--border);border-radius:3px;overflow:hidden}
.loading-fill{height:100%;background:var(--violet);border-radius:3px;animation:lbar 1.4s ease-in-out infinite}
@keyframes lbar{0%{width:0%;margin-left:0}50%{width:60%;margin-left:20%}100%{width:0%;margin-left:100%}}
.load-err{color:var(--red);font-size:.75rem;text-align:center;max-width:340px;line-height:1.7}
.btn-retry{margin-top:10px;background:none;border:1.5px solid var(--red);color:var(--red);font-size:.68rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;padding:8px 18px;border-radius:6px;cursor:pointer}
.btn-retry:hover{background:var(--red);color:#fff}

/* LIST TILES */
.tile{display:flex;align-items:center;gap:11px;padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;position:relative}
.tile:hover{background:var(--s2)}
.tile.on{background:var(--vlight)}
.tile.on::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--violet);border-radius:0 2px 2px 0}
.tile-img{width:50px;height:50px;border-radius:5px;object-fit:cover;flex-shrink:0;background:var(--border);box-shadow:0 2px 8px var(--shadow)}
.ti{flex:1;min-width:0}
.ti-art{font-size:.65rem;color:var(--violet);text-transform:uppercase;letter-spacing:.07em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700}
.ti-tit{font-size:.94rem;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.ti-meta{font-size:.64rem;color:var(--tdim);margin-top:2px;font-weight:400}
.ti-r{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
.ti-price{font-size:.84rem;font-weight:700;color:var(--violet)}
.lbl{font-size:.56rem;font-weight:700;letter-spacing:.04em;padding:2px 7px;border-radius:10px;white-space:nowrap}
.lbl-sh{background:#FEF3C7;color:#92400E}
.lbl-pre{background:var(--vlight);color:var(--violet)}
.lbl-new{background:#D1FAE5;color:#065F46}
.lbl-mix{background:#FFF7ED;color:#9A3412}
.no-res{padding:32px 14px;text-align:center;font-size:.72rem;font-weight:500;color:var(--tdim);letter-spacing:.08em;text-transform:uppercase}

/* MAIN */
main{grid-area:mn;overflow-y:auto;padding:32px 40px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;position:relative;background:var(--bg)}
main::-webkit-scrollbar{width:4px}
main::-webkit-scrollbar-thumb{background:var(--border2)}
.empty{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:var(--tdim)}
.empty .big{font-size:5rem;color:var(--border);line-height:1}
.empty p{font-size:.72rem;font-weight:500;letter-spacing:.18em;text-transform:uppercase;color:var(--tdim)}

/* GRID VIEW */
#grid-area{display:none;grid-area:mn;overflow-y:auto;padding:18px 22px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent;background:var(--bg)}
#grid-area::-webkit-scrollbar{width:4px}
#grid-area::-webkit-scrollbar-thumb{background:var(--border2)}
body.mode-grid #grid-area{display:block}
body.mode-grid main{display:none}
.grid-filterbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.gftab{padding:6px 13px;font-size:.65rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--tdim);background:var(--surface);border:1.5px solid var(--border2);border-radius:20px;cursor:pointer;transition:all .15s;white-space:nowrap}
.gftab:hover{color:var(--t2);border-color:var(--vdim)}
.gftab.on{color:var(--violet);border-color:var(--violet);background:var(--vlight)}
.grid-count{font-size:.65rem;font-weight:500;color:var(--tdim);letter-spacing:.06em;text-transform:uppercase;margin-left:auto}
.grid-inner{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:900px){.grid-inner{grid-template-columns:repeat(3,1fr);}}
.gc{position:relative;cursor:pointer;border-radius:8px;overflow:hidden;background:var(--surface);aspect-ratio:1;transition:transform .18s,box-shadow .18s;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.gc:hover{transform:scale(1.025);box-shadow:0 8px 24px rgba(124,58,237,.18)}
.gc.on{outline:2.5px solid var(--violet);outline-offset:-2px}
.gc img{width:100%;height:100%;object-fit:cover;display:block}
.gc-grad{position:absolute;inset:0;background:linear-gradient(to top,rgba(20,8,40,.85) 0%,rgba(20,8,40,.1) 45%,transparent 70%);pointer-events:none}
.gc-info{position:absolute;bottom:0;left:0;right:0;padding:10px 10px;pointer-events:none}
.gc-artist{font-size:.6rem;font-weight:700;color:var(--vlav);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gc-title{font-size:.86rem;font-weight:500;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.gc-price{font-size:.68rem;font-weight:700;color:var(--vlav);margin-top:3px}
.gc-badge{position:absolute;top:8px;right:8px;font-size:.5rem;font-weight:700;letter-spacing:.06em;padding:3px 7px;border-radius:12px;text-transform:uppercase;backdrop-filter:blur(6px)}
.gb-sh{background:rgba(254,243,199,.9);color:#92400E}
.gb-pre{background:rgba(237,233,255,.9);color:#5B21B6}
.gb-new{background:rgba(209,250,229,.9);color:#065F46}
.gb-mix{background:rgba(255,247,237,.9);color:#9A3412}
.gc-audio{position:absolute;top:9px;left:9px;width:8px;height:8px;border-radius:50%;background:var(--vlav);box-shadow:0 0 8px rgba(179,157,255,.8)}

/* MODAL */
#modal-overlay{display:none;position:fixed;inset:0;z-index:50;background:rgba(80,40,160,.2);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:20px}
#modal-overlay.open{display:flex;animation:fadein .2s ease}
@keyframes fadein{from{opacity:0}to{opacity:1}}
#modal-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:100%;max-width:800px;max-height:88vh;display:flex;flex-direction:column;overflow:hidden;animation:slideup .22s ease;box-shadow:0 24px 64px rgba(124,58,237,.2)}
@keyframes slideup{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 22px;border-bottom:1px solid var(--border);flex-shrink:0}
.modal-hdr-info{min-width:0}
.modal-artist{font-size:.65rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--violet)}
.modal-title{font-size:1.2rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.modal-close{width:34px;height:34px;border-radius:50%;border:1.5px solid var(--border2);background:none;color:var(--tdim);font-size:1rem;cursor:pointer;flex-shrink:0;transition:all .15s;display:flex;align-items:center;justify-content:center}
.modal-close:hover{border-color:var(--violet);color:var(--violet);background:var(--vlight)}
.modal-body{display:grid;grid-template-columns:200px 1fr;overflow:hidden;flex:1}
.modal-cover-col{padding:20px 16px 20px 22px;border-right:1px solid var(--border);display:flex;flex-direction:column;gap:10px;flex-shrink:0;background:var(--bg)}
.modal-cover{width:100%;aspect-ratio:1;border-radius:8px;object-fit:cover;display:block;background:var(--border);box-shadow:0 8px 24px rgba(124,58,237,.15)}
.modal-cover-badges{display:flex;gap:4px;flex-wrap:wrap}
.modal-scroll{overflow-y:auto;padding:22px;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}
.modal-scroll::-webkit-scrollbar{width:3px}
.modal-scroll::-webkit-scrollbar-thumb{background:var(--border2)}

/* DETAIL shared */
.d-art{font-size:.65rem;font-weight:700;letter-spacing:.16em;text-transform:uppercase;color:var(--violet);margin-bottom:6px}
.d-tit{font-size:1.8rem;font-weight:700;line-height:1.15;color:var(--text);margin-bottom:14px}
.d-specs{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border)}
.sp{display:flex;flex-direction:column;gap:3px}
.sp-l{font-size:.6rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--tdim)}
.sp-v{font-size:.9rem;color:var(--text);font-weight:500}
.sp-link{font-size:.9rem;color:var(--text);font-weight:500;cursor:pointer;border-bottom:1.5px solid transparent;transition:all .15s;display:inline}
.sp-link:hover{color:var(--violet);border-bottom-color:var(--vlav)}
.d-tags{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:18px}
.tag{font-size:.64rem;font-weight:600;letter-spacing:.04em;padding:4px 11px;border-radius:14px;background:var(--vlight);color:var(--violet);border:1.5px solid var(--vlav);cursor:pointer;transition:all .15s}
.tag:hover{background:var(--violet);color:#fff;border-color:var(--violet)}
.d-desc{font-size:.92rem;line-height:1.75;color:var(--t2);margin-bottom:24px}

/* stock */
.stock-section{margin-bottom:22px}
.stock-hdr{font-size:.64rem;font-weight:700;letter-spacing:.16em;text-transform:uppercase;color:var(--tdim);margin-bottom:10px}
.stock-new{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;gap:10px}
.sn-cond{font-size:.7rem;font-weight:600;color:var(--green);text-transform:uppercase;letter-spacing:.06em}
.sn-qty{font-size:.64rem;color:var(--tdim);margin-top:2px}
.sn-comment{font-size:.82rem;color:var(--t2);font-style:italic;margin-top:4px}
.sn-price{font-size:1.3rem;font-weight:700;color:var(--violet);flex-shrink:0}
.stock-sh-list{display:flex;flex-direction:column;gap:8px}
.sh-card{padding:13px 16px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;border-left:4px solid var(--vlav)}
.sh-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px}
.sh-cond{font-size:.65rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;display:flex;flex-direction:column;gap:5px}
.sh-grade{display:inline-flex;align-items:center;gap:7px}
.sh-grade-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;display:inline-block}
.sh-grade-lbl{font-size:.66rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase}
/* Goldmine grades light theme */
.gm-m   {color:#166534} .dot-m   {background:#16A34A}
.gm-nm  {color:#155E75} .dot-nm  {background:#0891B2}
.gm-vgp {color:#1E40AF} .dot-vgp {background:#3B82F6}
.gm-vg  {color:#713F12} .dot-vg  {background:#D97706}
.gm-gp  {color:#7C2D12} .dot-gp  {background:#EA580C}
.gm-g   {color:#991B1B} .dot-g   {background:#DC2626}
.gm-f   {color:#4C1D95} .dot-f   {background:#7C3AED}
.gm-p   {color:#374151} .dot-p   {background:#9CA3AF}
.sh-price{font-size:1.2rem;font-weight:700;color:var(--violet);flex-shrink:0}
.sh-comment{font-size:.84rem;color:var(--t2);line-height:1.55}

/* tracklist */
.tl-hdr{font-size:.64rem;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--tdim);margin-bottom:8px;margin-top:22px}
.tracklist{display:flex;flex-direction:column}
.track{display:flex;align-items:center;gap:10px;padding:8px 9px;border-radius:6px;transition:background .12s}
.track.has-audio{cursor:pointer}
.track.has-audio:hover{background:var(--s2)}
.track.playing{background:var(--vlight)}
.t-pos{font-size:.64rem;font-weight:500;color:var(--tdim);width:22px;flex-shrink:0;text-align:right}
.t-btn{width:26px;height:26px;border-radius:50%;border:1.5px solid var(--border2);background:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--tdim);transition:all .15s;flex-shrink:0}
.track.has-audio:hover .t-btn{border-color:var(--violet);color:var(--violet);background:var(--vlight)}
.track.playing .t-btn{border-color:var(--violet);color:#fff;background:var(--violet)}
.t-btn svg{width:8px;height:8px;fill:currentColor}
.ico-pause{display:none}
.track.playing .ico-play{display:none}
.track.playing .ico-pause{display:block}
.t-name{flex:1;font-size:.9rem;font-weight:400;color:var(--t2);transition:color .12s}
.track.has-audio:hover .t-name,.track.playing .t-name{color:var(--text)}

/* inline detail */
.det{display:grid;grid-template-columns:240px 1fr;gap:36px;animation:fu .22s ease}
@keyframes fu{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
.cov-col{position:sticky;top:0;align-self:start}
.det-cover{width:100%;aspect-ratio:1;border-radius:10px;object-fit:cover;box-shadow:0 12px 40px rgba(124,58,237,.18);display:block;background:var(--border)}
.cov-badges{margin-top:10px;display:flex;gap:5px;flex-wrap:wrap}
.cbadge{font-size:.6rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;padding:3px 9px;border-radius:12px;border:1.5px solid var(--border2);color:var(--tdim)}
.cbadge.pre{border-color:var(--vlav);color:var(--violet);background:var(--vlight)}
.cbadge.new{border-color:#6EE7B7;color:#065F46;background:#D1FAE5}
.cbadge.sh{border-color:#FDE68A;color:#92400E;background:#FEF3C7}

/* PLAYER */
#pbar{grid-area:pl;border-top:1px solid var(--border);background:var(--surface);padding:0 22px;display:flex;align-items:center;gap:16px;opacity:0;pointer-events:none;transition:opacity .3s;z-index:10;box-shadow:0 -1px 0 var(--border)}
#pbar.on{opacity:1;pointer-events:all}
.p-cov{width:44px;height:44px;border-radius:6px;object-fit:cover;flex-shrink:0;background:var(--border);box-shadow:0 2px 8px var(--shadow)}
.p-inf{flex:1;min-width:0}
.p-trk{font-size:.9rem;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:color .15s}
.p-trk:hover{color:var(--violet)}
.p-art{font-size:.64rem;font-weight:700;color:var(--violet);letter-spacing:.07em;text-transform:uppercase;transition:color .15s}
.p-art:hover{color:var(--vdim)}
.pctrl{display:flex;align-items:center;gap:7px}
.cb{width:32px;height:32px;border-radius:50%;border:1.5px solid var(--border2);background:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--tdim);transition:all .15s;flex-shrink:0}
.cb:hover{border-color:var(--violet);color:var(--violet)}
.cb.pp{width:40px;height:40px;border-color:var(--violet);color:var(--violet)}
.cb.pp:hover{background:var(--violet);color:#fff}
.cb svg{width:11px;height:11px;fill:currentColor}
.cb.pp svg{width:13px;height:13px}
.cb.pp .ico-pause{display:none}
.cb.pp.on .ico-play{display:none}
.cb.pp.on .ico-pause{display:block}
.pprog{flex:2;display:flex;flex-direction:column;gap:5px;min-width:0}
.pbar-inner{width:100%;height:3px;background:var(--border);border-radius:3px;cursor:pointer}
.pfill{height:100%;background:var(--violet);border-radius:3px;width:0%;transition:width .15s linear}
.ptimes{display:flex;justify-content:space-between;font-size:.6rem;font-weight:500;color:var(--tdim)}
.vol{display:flex;align-items:center;gap:6px}
.vol svg{width:13px;height:13px;fill:var(--tdim);flex-shrink:0}
input[type=range]{-webkit-appearance:none;appearance:none;width:68px;height:3px;background:var(--border);border-radius:3px;outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--violet);cursor:pointer}
</style>
</head>
<body class="mode-list">

<!-- Loading -->
<div class="loading-screen" id="loading">
  <div class="loading-logo">DandyRecords</div>
  <div class="loading-bar"><div class="loading-fill"></div></div>
  <div class="loading-msg" id="loading-msg">Chargement du catalogue…</div>
</div>

<!-- Detail modal (grid mode) -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div id="modal-box">
    <div class="modal-hdr">
      <div class="modal-hdr-info">
        <div class="modal-artist" id="modal-artist">—</div>
        <div class="modal-title" id="modal-title">—</div>
      </div>
      <button class="modal-close" onclick="closeModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="modal-cover-col">
        <img class="modal-cover" id="modal-cover" src="" alt="">
        <div class="modal-cover-badges" id="modal-badges"></div>
      </div>
      <div class="modal-scroll" id="modal-content"></div>
    </div>
  </div>
</div>

<header>
  <div class="logo">
    <span class="logo-name">DandyRecords</span>
    <span class="logo-sub">Paris</span>
  </div>
  <!-- list mode breadcrumb -->
  <div class="nav-crumb" id="nav-crumb" style="display:none">
    <span class="crumb-root" onclick="clearNav()">Catalogue</span>
    <span class="crumb-sep">›</span>
    <span class="crumb-item" id="crumb-label">—</span>
  </div>
  <!-- grid mode search -->
  <div class="grid-search-wrap">
    <span class="gsi">⌕</span>
    <input id="grid-search" type="text" placeholder="Artiste, titre, label, genre…" autocomplete="off">
    <button class="search-clear" id="grid-search-clear" onclick="clearSearch('grid-search')" style="display:none">✕</button>
  </div>
  <div class="hd-right">
    <div class="badge-event">Paris Loves Vinyl</div>
    <div class="view-toggle">
      <button class="vbtn on" id="vbtn-list" onclick="setView('list')" title="Vue liste">
        <svg viewBox="0 0 12 12"><rect x="0" y="1" width="12" height="2"/><rect x="0" y="5" width="12" height="2"/><rect x="0" y="9" width="12" height="2"/></svg>
      </button>
      <button class="vbtn" id="vbtn-grid" onclick="setView('grid')" title="Vue grille">
        <svg viewBox="0 0 12 12"><rect x="0" y="0" width="5" height="5"/><rect x="7" y="0" width="5" height="5"/><rect x="0" y="7" width="5" height="5"/><rect x="7" y="7" width="5" height="5"/></svg>
      </button>
    </div>
    <button class="btn-refresh" id="btn-refresh" onclick="loadData(true)">
      <span class="ri">↻</span> Refresh
    </button>
  </div>
</header>

<!-- SIDEBAR (list mode only) -->
<aside>
  <div class="search-wrap">
    <span class="si">⌕</span>
    <input id="search" type="text" placeholder="Artiste, titre, label…" autocomplete="off">
    <button class="search-clear" id="search-clear" onclick="clearSearch('search')" style="display:none">✕</button>
  </div>
  <div class="afbar" id="afbar">
    <span class="af-label" id="af-label"></span>
    <button class="af-clear" onclick="clearNav()">✕</button>
  </div>
  <div class="ftabs">
    <button class="ftab on" data-f="all">Tout</button>
    <button class="ftab" data-f="new">Neuf</button>
    <button class="ftab" data-f="sh">Occasion</button>
    <button class="ftab" data-f="pre">Préco</button>
    <button class="ftab" data-f="jazz">Jazz</button>
    <button class="ftab" data-f="citypop">City Pop</button>
    <button class="ftab" data-f="fusion">Fusion</button>
    <button class="ftab" data-f="soul">Soul/Funk</button>
    <button class="ftab" data-f="elec">Electronic</button>
    <button class="ftab" data-f="ost">Soundtrack</button>
  </div>
  <div class="sb-toolbar">
    <div class="count" id="count-list">—</div>
  </div>
  <div class="list" id="list"></div>
</aside>

<!-- MAIN (list mode detail) -->
<main id="main">
  <div class="empty" id="empty">
    <div class="big">♫</div>
    <p>Sélectionne un disque</p>
  </div>
  <div id="det" style="display:none"></div>
</main>

<!-- GRID AREA (grid mode full width) -->
<div id="grid-area">
  <div class="grid-filterbar" id="grid-filterbar">
    <button class="gftab on" data-f="all">Tout</button>
    <button class="gftab" data-f="new">Neuf</button>
    <button class="gftab" data-f="sh">Occasion</button>
    <button class="gftab" data-f="pre">Préco</button>
    <button class="gftab" data-f="jazz">Jazz</button>
    <button class="gftab" data-f="citypop">City Pop</button>
    <button class="gftab" data-f="fusion">Fusion</button>
    <button class="gftab" data-f="soul">Soul/Funk</button>
    <button class="gftab" data-f="elec">Electronic</button>
    <button class="gftab" data-f="ost">Soundtrack</button>
    <span class="grid-count" id="count-grid">—</span>
  </div>
  <div class="grid-inner" id="grid-inner"></div>
</div>

<!-- PLAYER BAR -->
<div id="pbar">
  <img class="p-cov" id="p-cov" src="" alt="">
  <div class="p-inf">
    <div class="p-trk" id="p-trk">—</div>
    <div class="p-art" id="p-art">—</div>
  </div>
  <div class="pctrl">
    <button class="cb" id="b-prev"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/></svg></button>
    <button class="cb pp" id="b-pp">
      <svg class="ico-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg class="ico-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </button>
    <button class="cb" id="b-next"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm2-8.14 5.09 2.14L8 14.14V9.86zM16 6h2v12h-2z"/></svg></button>
  </div>
  <div class="pprog">
    <div class="pbar-inner" id="prog"><div class="pfill" id="fill"></div></div>
    <div class="ptimes"><span id="tc">0:00</span><span id="tt">0:00</span></div>
  </div>
  <div class="vol">
    <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
    <input type="range" id="vol" min="0" max="1" step="0.05" value="0.8">
  </div>
</div>

<audio id="aud"></audio>

<script>
// ── CONFIG ─────────────────────────────────────────────────────────────
const SHEET_ID='1adNI1aCJb2-Ym2kYYHg0tol56sGIa78-gImVY7dkKqU';
const CSV_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&t=`;

// ── STATE ──────────────────────────────────────────────────────────────
let ALL=[];
const S={filtered:[],cur:null,tIdx:null,filter:'all',q:'',nav:null,view:'list'};
const aud=document.getElementById('aud');

// ── CSV PARSER ─────────────────────────────────────────────────────────
function parseCSV(text){
  const rows=[];let cur='',inQ=false;
  const parseLine=line=>{
    const cells=[];let c='',q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){if(q&&line[i+1]==='"'){c+='"';i++;}else q=!q;}
      else if(ch===','&&!q){cells.push(c);c='';}
      else c+=ch;
    }
    cells.push(c);return cells;
  };
  for(const ch of text){
    if(ch==='"')inQ=!inQ;
    if(ch==='\n'&&!inQ){rows.push(parseLine(cur));cur='';}
    else cur+=ch;
  }
  if(cur.trim())rows.push(parseLine(cur));
  if(!rows.length)return[];
  const headers=rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r=>r.length>1&&r.some(c=>c.trim()))
    .map(row=>Object.fromEntries(headers.map((h,i)=>[h,(row[i]||'').trim()])));
}

// ── BUILD RELEASE GROUPS ───────────────────────────────────────────────
function buildGroups(rows){
  const active=rows.filter(r=>{
    const qty=parseInt(r.listing_stock_quantity)||0;
    return qty>0||r.listing_pre_order==='TRUE';
  });
  const byId={};
  for(const row of active){const id=row.item_id;if(!id)continue;if(!byId[id])byId[id]=[];byId[id].push(row);}
  return Object.values(byId).map(listings=>{
    const rep=listings[0];
    const tracks=[];
    for(const t of(rep.release_tracklist||'').split(';')){
      const s=t.trim();if(!s)continue;
      const parts=s.split(' - ');
      if(parts.length>=2){const pos=parts[0].trim(),title=parts[1].trim();
        if(title&&title!=='null'&&pos&&!pos.startsWith('-'))tracks.push({position:pos,title});}
    }
    const genres=(rep.release_genres||'').split(';').map(g=>g.trim()).filter(Boolean);
    const styles=(rep.release_styles||'').split(';').map(s=>s.trim()).filter(Boolean);
    const tags=[...new Set([...genres,...styles])];
    const label=(rep.release_labels_formatted||'').split(';')[0].replace(/\s*\(.*?\)\s*/g,'').trim();
    let audioBase=(rep.item_asset_link||'').trim();
    if(audioBase&&!audioBase.endsWith('/'))audioBase+='/';

    const newL=listings.filter(l=>l.listing_second_hand!=='TRUE'&&l.listing_pre_order!=='TRUE');
    const preL=listings.filter(l=>l.listing_pre_order==='TRUE');
    const shL =listings.filter(l=>l.listing_second_hand==='TRUE');

    const newEntry=newL.length?{
      qty:newL.reduce((s,l)=>s+(parseInt(l.listing_stock_quantity)||0),0),
      price:Math.min(...newL.map(l=>parseFloat(l.listing_price)||999))+'€',
      condition:newL[0].listing_media_condition,
      comment:newL[0].listing_public_comments,
    }:null;
    const preEntry=preL.length?{
      qty:preL.reduce((s,l)=>s+(parseInt(l.listing_stock_quantity)||0),0),
      price:Math.min(...preL.map(l=>parseFloat(l.listing_price)||999))+'€',
      condition:preL[0].listing_media_condition,
      comment:preL[0].listing_public_comments,
      availableDate:preL[0].listing_available_date,
    }:null;
    const shEntries=shL.map(l=>({
      qty:parseInt(l.listing_stock_quantity)||0,
      price:l.listing_price?l.listing_price+'€':'',
      condition:l.listing_media_condition,
      sleeve:l.listing_sleeve_condition,
      comment:l.listing_public_comments,
    })).filter(e=>e.qty>0);

    const allP=[...(newEntry?[parseFloat(newEntry.price)]:[]),(preEntry?[parseFloat(preEntry.price)]:[]),...shEntries.map(e=>parseFloat(e.price)||999)].flat();
    const displayPrice=allP.length?Math.min(...allP)+'€':'';
    const hasNew=!!newEntry,hasPre=!!preEntry,hasSh=shEntries.length>0;

    return{
      id:rep.item_id,discogs_id:rep.release_discogs_id,title:rep.item_title,
      artist:(rep.release_artists_formatted||'').trim(),label,tags,genres,styles,
      catno:(rep.release_catnos||'').split(';')[0].trim(),year:rep.release_year,
      country:rep.release_country,cover:rep.item_image_link,formats:rep.release_formats,
      description:(rep.item_long_description||rep.item_short_description||'').trim(),
      tracks,audioBase,url:rep.item_eshop_link,
      newEntry,preEntry,shEntries,hasNew,hasPre,hasSh,displayPrice,
      secondHand:hasSh&&!hasNew&&!hasPre,preorder:hasPre&&!hasNew&&!hasSh,isNew:hasNew&&!hasSh,
    };
  });
}

// ── LOAD DATA ──────────────────────────────────────────────────────────
async function loadData(isRefresh=false){
  const loadEl=document.getElementById('loading'),msgEl=document.getElementById('loading-msg'),btnRef=document.getElementById('btn-refresh');
  if(isRefresh){btnRef.classList.add('spinning');}
  else{loadEl.querySelectorAll('.load-err,.btn-retry').forEach(e=>e.remove());msgEl.textContent='Chargement du catalogue…';loadEl.classList.remove('hidden');}
  try{
    const res=await fetch(CSV_URL+Date.now());
    if(!res.ok)throw new Error(`Erreur HTTP ${res.status}`);
    ALL=buildGroups(parseCSV(await res.text()));
    applyFilters();loadEl.classList.add('hidden');
  }catch(err){
    if(isRefresh){console.error(err);}
    else{
      msgEl.textContent='';
      const d=document.createElement('div');d.className='load-err';
      d.innerHTML=`Impossible de charger le catalogue.<br><small style="opacity:.7">${err.message}</small><br><br>Vérifie que le Google Sheets est partagé en accès public.`;
      const b=document.createElement('button');b.className='btn-retry';b.textContent='↻ Réessayer';b.onclick=()=>loadData(false);
      loadEl.appendChild(d);loadEl.appendChild(b);
    }
  }finally{btnRef.classList.remove('spinning');}
}

// ── VIEW TOGGLE ────────────────────────────────────────────────────────
function setView(v){
  S.view=v;
  document.body.className=`mode-${v}`;
  document.getElementById('vbtn-list').classList.toggle('on',v==='list');
  document.getElementById('vbtn-grid').classList.toggle('on',v==='grid');
  applyFilters();
}

// ── NAVIGATION ─────────────────────────────────────────────────────────
function navTo(type,value){
  S.nav={type,value};S.q='';
  document.getElementById('search').value='';
  document.getElementById('grid-search').value='';
  const TL={artist:'Artiste',label:'Label',year:'Année',country:'Pays',genre:'Genre'};
  const lbl=`${TL[type]||type} : ${value}`;
  document.getElementById('af-label').textContent=lbl;
  document.getElementById('afbar').classList.add('show');
  document.getElementById('nav-crumb').style.display='flex';
  document.getElementById('crumb-label').textContent=value;
  updateGridNavPill();
  applyFilters();
  if(S.view==='list')document.getElementById('list').scrollTo({top:0,behavior:'smooth'});
  else document.getElementById('grid-area').scrollTo({top:0,behavior:'smooth'});
}
function clearNav(){
  S.nav=null;
  document.getElementById('afbar').classList.remove('show');
  document.getElementById('nav-crumb').style.display='none';
  updateGridNavPill();
  applyFilters();
}
function updateGridNavPill(){
  let pill=document.getElementById('grid-nav-pill');
  if(!S.nav){if(pill)pill.remove();return;}
  if(!pill){
    pill=document.createElement('div');pill.id='grid-nav-pill';
    pill.style.cssText='display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;border:1px solid var(--gold);background:rgba(201,168,76,.1);font-family:"Space Mono",monospace;font-size:.52rem;letter-spacing:.07em;color:var(--gold);text-transform:uppercase;white-space:nowrap;';
    const txt=document.createTextNode('');
    const x=document.createElement('span');x.textContent='✕';x.style.cssText='cursor:pointer;margin-left:2px;opacity:.8;';x.onclick=clearNav;
    pill.appendChild(txt);pill.appendChild(x);
    document.getElementById('grid-filterbar').insertBefore(pill,document.getElementById('count-grid'));
  }
  const TL={artist:'Artiste',label:'Label',year:'Année',country:'Pays',genre:'Genre'};
  pill.childNodes[0].nodeValue=`${TL[S.nav.type]||S.nav.type} : ${S.nav.value} `;
}

// ── FILTERS ────────────────────────────────────────────────────────────
const GF={
  all:()=>true,new:r=>r.isNew||r.hasNew,sh:r=>r.hasSh,pre:r=>r.hasPre||r.preorder,
  jazz:r=>r.genres.includes('Jazz')||r.styles.some(s=>/jazz/i.test(s)),
  citypop:r=>r.styles.includes('City Pop')||r.styles.includes('Kayōkyoku'),
  fusion:r=>r.styles.includes('Fusion'),
  soul:r=>r.genres.includes('Funk / Soul')||r.styles.includes('Soul')||r.styles.includes('Funk'),
  elec:r=>r.genres.includes('Electronic')||r.styles.some(s=>/synth|boogie|electro/i.test(s)),
  ost:r=>r.genres.includes('Stage & Screen')||r.styles.includes('Soundtrack')||r.styles.includes('Anison'),
};
function matchNav(r){
  if(!S.nav)return true;const v=S.nav.value;
  switch(S.nav.type){case'artist':return r.artist===v;case'label':return r.label===v;case'year':return r.year===v;case'country':return r.country===v;case'genre':return r.tags.includes(v);default:return true;}
}
function applyFilters(){
  const q=S.q.toLowerCase();
  S.filtered=ALL.filter(r=>{
    const mq=!q||r.title.toLowerCase().includes(q)||r.artist.toLowerCase().includes(q)||r.label.toLowerCase().includes(q)||r.catno.toLowerCase().includes(q)||r.tags.some(t=>t.toLowerCase().includes(q));
    return mq&&GF[S.filter](r)&&matchNav(r);
  });
  const n=S.filtered.length;
  document.getElementById('count-list').textContent=n+' disque'+(n!==1?'s':'');
  document.getElementById('count-grid').textContent=n+' disque'+(n!==1?'s':'');
  if(S.view==='list')renderList();else renderGrid();
}

// ── GOLDMINE GRADE helper ──────────────────────────────────────────────
function gmGrade(raw){
  if(!raw)return{cls:'gm-p',dot:'dot-p',label:'?'};
  const s=raw.toLowerCase().replace(/[\s()]/g,'');
  if(s==='m'||s.startsWith('mint'))               return{cls:'gm-m',  dot:'dot-m',  label:raw};
  if(s==='nm'||s==='nm+'||s.startsWith('nearmint'))return{cls:'gm-nm', dot:'dot-nm', label:raw};
  if(s==='vg+'||s.includes('vg+')||s.includes('veryg+'))return{cls:'gm-vgp',dot:'dot-vgp',label:raw};
  if(s==='vg'||s.startsWith('veryg'))             return{cls:'gm-vg', dot:'dot-vg', label:raw};
  if(s==='g+'||s.includes('good+'))               return{cls:'gm-gp', dot:'dot-gp', label:raw};
  if(s==='g'||s.startsWith('good'))               return{cls:'gm-g',  dot:'dot-g',  label:raw};
  if(s.startsWith('fair'))                        return{cls:'gm-f',  dot:'dot-f',  label:raw};
  if(s==='p'||s.startsWith('poor'))               return{cls:'gm-p',  dot:'dot-p',  label:raw};
  return{cls:'gm-vg',dot:'dot-vg',label:raw};
}
function gradeHTML(raw,roleLabel){
  const{cls,dot,label}=gmGrade(raw);
  return`<div class="sh-grade"><span class="sh-grade-dot ${dot}"></span><span class="sh-grade-lbl" style="color:var(--tdim);opacity:.6;margin-right:1px">${roleLabel} :</span><span class="sh-grade-lbl ${cls}">${label}</span></div>`;
}

// ── BADGE HELPERS ──────────────────────────────────────────────────────
function statusBadge(r){
  if(r.hasNew&&r.hasSh)return{cls:'lbl-mix',txt:'Neuf + Occ.'};
  if(r.hasPre&&r.hasSh)return{cls:'lbl-mix',txt:'Préco + Occ.'};
  if(r.hasPre)return{cls:'lbl-pre',txt:'Préco'};
  if(r.hasSh&&!r.hasNew)return{cls:'lbl-sh',txt:'Occasion'};
  return{cls:'lbl-new',txt:'Neuf'};
}
function gcBadge(r){
  if(r.hasNew&&r.hasSh)return['gb-mix','Neuf + Occ.'];
  if(r.hasPre)return['gb-pre','Préco'];
  if(r.hasSh&&!r.hasNew)return['gb-sh','Occasion'];
  return['gb-new','Neuf'];
}

// ── RENDER LIST ────────────────────────────────────────────────────────
function renderList(){
  const el=document.getElementById('list');
  if(!S.filtered.length){el.innerHTML='<div class="no-res">Aucun résultat</div>';return;}
  el.innerHTML=S.filtered.map(r=>{
    const{cls,txt}=statusBadge(r);
    const act=S.cur?.id===r.id?' on':'';
    const meta=[r.label,r.catno,r.year].filter(Boolean).join(' · ');
    return`<div class="tile${act}" data-id="${r.id}" onclick="selectRecord('${r.id}')">
      <img class="tile-img" src="${r.cover}" alt="" loading="lazy" onerror="this.style.opacity=0">
      <div class="ti">
        <div class="ti-art">${r.artist}</div>
        <div class="ti-tit">${r.title}</div>
        <div class="ti-meta">${meta}</div>
      </div>
      <div class="ti-r">${r.displayPrice?`<span class="ti-price">${r.displayPrice}</span>`:''}<span class="lbl ${cls}">${txt}</span></div>
    </div>`;
  }).join('');
}

// ── RENDER GRID ────────────────────────────────────────────────────────
function renderGrid(){
  const el=document.getElementById('grid-inner');
  if(!S.filtered.length){el.innerHTML='<div class="no-res" style="grid-column:1/-1;padding:40px">Aucun résultat</div>';return;}
  el.innerHTML=S.filtered.map(r=>{
    const[bc,bt]=gcBadge(r);
    const act=S.cur?.id===r.id?' on':'';
    const audioDot=r.audioBase?'<div class="gc-audio"></div>':'';
    return`<div class="gc${act}" data-id="${r.id}" onclick="openModal('${r.id}')">
      <img src="${r.cover}" alt="${r.title}" loading="lazy" onerror="this.style.background='#2a2824'">
      <div class="gc-grad"></div>
      ${audioDot}
      <span class="gc-badge ${bc}">${bt}</span>
      <div class="gc-info">
        <div class="gc-artist">${r.artist}</div>
        <div class="gc-title">${r.title}</div>
        ${r.displayPrice?`<div class="gc-price">${r.displayPrice}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

// ── DETAIL HTML builder (shared) ──────────────────────────────────────
function buildDetailHTML(r){
  const esc=v=>v.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
  const fmt=r.formats.replace(/\d+x\s*/g,'').replace(/\(.*?\)/g,'').trim();
  const spec=(lbl,val,nt)=>{
    if(!val)return'';
    const inner=nt?`<span class="sp-link" onclick="navTo('${nt}','${esc(val)}');closeModal()">${val}</span>`:`<span class="sp-v">${val}</span>`;
    return`<div class="sp"><div class="sp-l">${lbl}</div>${inner}</div>`;
  };
  const tagsHtml=r.tags.length?`<div class="d-tags">${r.tags.map(t=>`<span class="tag" onclick="navTo('genre','${esc(t)}');closeModal()">${t}</span>`).join('')}</div>`:'';
  let stockHtml='<div class="stock-section"><div class="stock-hdr">Disponibilité</div>';
  if(r.preEntry){const pe=r.preEntry;const ds=pe.availableDate?` — dispo ${new Date(pe.availableDate).toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'})}`:'';
    stockHtml+=`<div class="stock-new" style="border-left:3px solid var(--gdim);margin-bottom:8px"><div><div class="sn-cond" style="color:var(--gdim)">Précommande${ds}</div>${pe.qty?`<div class="sn-qty">${pe.qty} réservé${pe.qty>1?'s':''}</div>`:''} ${pe.comment?`<div class="sn-comment">${pe.comment}</div>`:''}</div>${pe.price?`<div class="sn-price">${pe.price}</div>`:''}</div>`;}
  if(r.newEntry){const ne=r.newEntry;
    stockHtml+=`<div class="stock-new" style="margin-bottom:${r.shEntries.length?'8px':'0'}"><div><div class="sn-cond">${gradeHTML(ne.condition||'Mint (M)','Disque')}</div>${ne.qty>1?`<div class="sn-qty">${ne.qty} exemplaires</div>`:''} ${ne.comment?`<div class="sn-comment">${ne.comment}</div>`:''}</div>${ne.price?`<div class="sn-price">${ne.price}</div>`:''}</div>`;}
  if(r.shEntries.length){stockHtml+=`<div class="stock-sh-list">`;r.shEntries.forEach(sh=>{
    const mediaGrade=gradeHTML(sh.condition,'Disque');
    const sleeveGrade=sh.sleeve?gradeHTML(sh.sleeve,'Pochette'):'';
    stockHtml+=`<div class="sh-card"><div class="sh-top"><div class="sh-cond">${mediaGrade}${sleeveGrade}</div>${sh.price?`<div class="sh-price">${sh.price}</div>`:''}</div>${sh.comment?`<div class="sh-comment">${sh.comment}</div>`:''}</div>`;
  });stockHtml+=`</div>`;}
  stockHtml+='</div>';
  const tlHtml=r.tracks.length?(()=>{
    const hb=!!r.audioBase;
    return`<div class="tl-hdr">Tracklist — ${r.tracks.length} titres${hb?' · extraits disponibles':''}</div><div class="tracklist" id="tl-${r.id}">${r.tracks.map((t,i)=>{
      const cls=hb?'track has-audio':'track';
      const evt=hb?`onclick="playTrack('${r.id}',${i})"`:'' ;
      const btn=hb?`<button class="t-btn" onclick="event.stopPropagation();playTrack('${r.id}',${i})"><svg class="ico-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><svg class="ico-pause" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>`:`<div style="width:24px;height:24px;flex-shrink:0"></div>`;
      return`<div class="${cls}" id="tr-${r.id}-${i}" data-idx="${i}" ${evt}><span class="t-pos">${t.position}</span>${btn}<span class="t-name">${t.title}</span></div>`;
    }).join('')}</div>`;
  })():'';
  const descHtml=r.description?`<div class="d-desc">${r.description.replace(/<br\s*\/?>/gi,'').replace(/\n/g,'<br>')}</div>`:'';
  return`<div class="d-specs">${spec('Artiste',r.artist,'artist')}${spec('Label',r.label,'label')}${spec('Cat. N°',r.catno,null)}${spec('Année',r.year,'year')}${spec('Pays',r.country,'country')}${fmt?`<div class="sp"><div class="sp-l">Format</div><div class="sp-v">${fmt}</div></div>`:''}</div>${tagsHtml}${stockHtml}${descHtml}${tlHtml}`;
}

// ── SELECT RECORD (list mode) ──────────────────────────────────────────
function selectRecord(id){
  const r=ALL.find(x=>x.id===id);if(!r)return;
  S.cur=r;S.tIdx=null;
  document.querySelectorAll('.tile').forEach(el=>el.classList.toggle('on',el.dataset.id===id));
  document.getElementById('empty').style.display='none';
  const det=document.getElementById('det');det.style.display='block';
  const badges=[r.preorder?'<span class="cbadge pre">Précommande</span>':'',!r.secondHand&&!r.preorder?'<span class="cbadge new">Neuf</span>':'',r.secondHand?'<span class="cbadge sh">Occasion</span>':''].filter(Boolean).join('');
  det.innerHTML=`<div class="det"><div class="cov-col"><img class="det-cover" src="${r.cover}" alt="${r.title}" onerror="this.style.opacity=.3"><div class="cov-badges">${badges}</div></div><div class="info"><div class="d-art">${r.artist}</div><div class="d-tit">${r.title}</div>${buildDetailHTML(r)}</div></div>`;
  document.getElementById('main').scrollTo({top:0,behavior:'smooth'});
}

// ── MODAL (grid mode) ──────────────────────────────────────────────────
function openModal(id){
  const r=ALL.find(x=>x.id===id);if(!r)return;
  S.cur=r;S.tIdx=null;
  document.querySelectorAll('.gc').forEach(el=>el.classList.toggle('on',el.dataset.id===id));
  document.getElementById('modal-artist').textContent=r.artist;
  document.getElementById('modal-title').textContent=r.title;
  document.getElementById('modal-cover').src=r.cover;
  const badges=[r.preorder?'<span class="cbadge pre">Précommande</span>':'',!r.secondHand&&!r.preorder?'<span class="cbadge new">Neuf</span>':'',r.secondHand?'<span class="cbadge sh">Occasion</span>':''].filter(Boolean).join('');
  document.getElementById('modal-badges').innerHTML=badges;
  document.getElementById('modal-content').innerHTML=buildDetailHTML(r);
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(e){
  if(e&&e.target!==document.getElementById('modal-overlay'))return;
  document.getElementById('modal-overlay').classList.remove('open');
}
// close on Escape
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

// ── AUDIO ──────────────────────────────────────────────────────────────
function audioUrl(r,i){if(!r.audioBase)return null;return r.audioBase+r.discogs_id+'_'+(i+1)+'.mp3';}
function playTrack(recordId,tIdx){
  const r=ALL.find(x=>x.id===recordId);if(!r?.audioBase)return;
  const track=r.tracks[tIdx];if(!track)return;
  if(S.cur?.id===r.id&&S.tIdx===tIdx){aud.paused?aud.play():aud.pause();return;}
  S.cur=r;S.tIdx=tIdx;
  aud.src=audioUrl(r,tIdx);aud.volume=parseFloat(document.getElementById('vol').value);
  aud.play().catch(()=>{
    // file missing — try next track automatically
    if(tIdx+1<r.tracks.length)playTrack(recordId,tIdx+1);
    else updUI(recordId,tIdx,false);
  });
  // update player bar
  document.getElementById('p-cov').src=r.cover;
  document.getElementById('p-trk').textContent=track.title;
  document.getElementById('p-art').textContent=r.artist;
  // make title & artist clickable
  document.getElementById('p-trk').onclick=()=>{ if(S.view==='list')selectRecord(r.id); else openModal(r.id); };
  document.getElementById('p-trk').style.cursor='pointer';
  document.getElementById('p-art').onclick=()=>navTo('artist',r.artist);
  document.getElementById('p-art').style.cursor='pointer';
  document.getElementById('pbar').classList.add('on');
}
function updUI(rid,ti,playing){
  document.querySelectorAll('.track').forEach(el=>el.classList.remove('playing'));
  if(playing){const el=document.getElementById(`tr-${rid}-${ti}`);if(el)el.classList.add('playing');}
  document.getElementById('b-pp').classList.toggle('on',playing);
}
const fmtT=s=>(!s||isNaN(s))?'0:00':Math.floor(s/60)+':'+String(Math.floor(s%60)).padStart(2,'0');
aud.addEventListener('timeupdate',()=>{const p=aud.duration?(aud.currentTime/aud.duration)*100:0;document.getElementById('fill').style.width=p+'%';document.getElementById('tc').textContent=fmtT(aud.currentTime);document.getElementById('tt').textContent=fmtT(aud.duration);});
aud.addEventListener('play',()=>updUI(S.cur?.id,S.tIdx,true));
aud.addEventListener('pause',()=>updUI(S.cur?.id,S.tIdx,false));
aud.addEventListener('ended',()=>{
  // auto-advance: try next tracks until one loads or end of album
  if(S.cur&&S.tIdx!==null){
    const next=S.tIdx+1;
    if(next<S.cur.tracks.length&&S.cur.audioBase)playTrack(S.cur.id,next);
    else updUI(S.cur?.id,S.tIdx,false);
  }
});
document.getElementById('b-pp').addEventListener('click',()=>{aud.paused?aud.play():aud.pause();});
document.getElementById('b-prev').addEventListener('click',()=>{if(S.cur&&S.tIdx>0)playTrack(S.cur.id,S.tIdx-1);});
document.getElementById('b-next').addEventListener('click',()=>{if(S.cur&&S.tIdx!==null&&S.tIdx<S.cur.tracks.length-1)playTrack(S.cur.id,S.tIdx+1);});
document.getElementById('prog').addEventListener('click',e=>{if(!aud.duration)return;const rc=e.currentTarget.getBoundingClientRect();aud.currentTime=((e.clientX-rc.left)/rc.width)*aud.duration;});
document.getElementById('vol').addEventListener('input',e=>{aud.volume=+e.target.value;});

// ── FILTER TABS (sidebar) ──────────────────────────────────────────────
document.querySelectorAll('.ftab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.ftab').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');S.filter=btn.dataset.f;
    // sync grid tabs
    document.querySelectorAll('.gftab').forEach(b=>b.classList.toggle('on',b.dataset.f===S.filter));
    applyFilters();
  });
});
// ── FILTER TABS (grid) ─────────────────────────────────────────────────
document.querySelectorAll('.gftab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.gftab').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');S.filter=btn.dataset.f;
    document.querySelectorAll('.ftab').forEach(b=>b.classList.toggle('on',b.dataset.f===S.filter));
    applyFilters();
  });
});

// ── SEARCH ────────────────────────────────────────────────────────────
let _st;
function doSearch(q,sourceId){
  clearTimeout(_st);
  // sync the other search input
  const otherId=sourceId==='search'?'grid-search':'search';
  document.getElementById(otherId).value=q;
  // show/hide clear buttons
  document.getElementById('search-clear').style.display=q?'block':'none';
  document.getElementById('grid-search-clear').style.display=q?'block':'none';
  if(S.nav)clearNav();
  _st=setTimeout(()=>{S.q=q;applyFilters();},160);
}
function clearSearch(inputId){
  document.getElementById(inputId).value='';
  document.getElementById('search').value='';
  document.getElementById('grid-search').value='';
  document.getElementById('search-clear').style.display='none';
  document.getElementById('grid-search-clear').style.display='none';
  S.q='';applyFilters();
  document.getElementById(inputId).focus();
}
document.getElementById('search').addEventListener('input',e=>doSearch(e.target.value,'search'));
document.getElementById('grid-search').addEventListener('input',e=>doSearch(e.target.value,'grid-search'));

// ── INIT ──────────────────────────────────────────────────────────────
loadData(false);
</script>
</body>
</html>
